<!DOCTYPE html>
<html lang="eng">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=.7"/>
    <meta name="description" content="frequency links (2023). a multi-player synthesizer" />
    <meta name="robots" content="index,follow" />
    <meta property="og:title" content="frequency links (2023)" />
    <meta property="og:type" content="article" />
    <meta property="og:url"/>
    <meta property="og:description" content="frequency links by Tommy (2023)" />
    <meta
      property="og:image"
      content="https://cdn.glitch.global/ad6b13f4-0f90-4f8d-83f1-e75baf871626/behavioralist screeny?v=1698220583140"
    />
    <meta name="twitter:card" content="summary" />
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Playfair">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script type="text/javascript" src="https://cdn.cycling74.com/rnbo/1.1.0/rnbo.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const { createDevice } = RNBO;
      let context;
      let socket = io();
      let el;
      let buttonEl;
      let playing = false;
      let nameField;
      let audioPlayer;
      let source;
      let freq;
      let oscillator;
      
      let samples = ["sample1.mp3", "sample2.mp3", "sample3.mp3"]

      document.addEventListener('DOMContentLoaded', function(event) { 
        nameField = document.querySelector("#name"); 
        buttonEl = document.querySelector('#buttonText');
        freqState = document.querySelector('.freqState');
        freq = document.querySelector('#frequency');
      })
      function getRandomInt(max) {
        return Math.floor(Math.random() * max);
      }
      
      function sendFreq(){
        const data = [nameField.value, freq.value]
        socket.emit("frequency", data);
        console.log(data);
      }
   
      socket.on('freqResponse', (data) => {
        console.log(data);
        freqState.innerHTML = data[0] + " changed the frequency to " + data[1];
        console.log(samples[data[1]]);
        oscillator.frequency.setValueAtTime(data[1], context.currentTime);
      });
      //log new users as they come into the room
      socket.on('response', (data) => {
        console.log(data);
        freqState.innerHTML = data + " joined the room";
      });
      //messages can come straight from the server, not just from other clients! look inside of the server.js code to see the server emitting a trigger  
      socket.on('trigger', (data) => {
        console.log(data[0]);
        console.log(data[1]); 
      });
      
      function play(file) {
        context.resume();
      }

      function gust(){
        if (!playing) {
          buttonEl.innerHTML="stop";
          playing = true;
          //videoEl.muted = false;
          context.resume();
        }
        else {
          buttonEl.innerHTML="play";
          //context.suspend();
          playing = false;
        }
      }
      /*
      function stop(){
        videoEl.pause();
        videoEl.src=null;
        context.suspend()
      }*/

      function submit() {
        //playing = true;
        context.resume();
        nameField.classList.add('disappear');
        socket.emit("name", nameField.value);
        document.querySelector("#instruction").classList.add('disappear');
        document.querySelector("#submit").classList.add('disappear');
        document.querySelector("#nameStuff").classList.add('disappear');
        buttonEl.style.opacity = 1;
        document.querySelector("#inputStuff").style.opacity = 1;
      }

      async function setup() {
          const WAContext = window.AudioContext || window.webkitAudioContext;
          context = new WAContext();
          // Create gain node and connect it to audio output
          const outputNode = context.createGain();
          outputNode.connect(context.destination);
          // create Oscillator node
          oscillator = context.createOscillator();
          oscillator.type = "square";
          oscillator.frequency.setValueAtTime(440, context.currentTime); // value in hertz
          oscillator.start();
          let response = await fetch("rnbo.filterdelay.json");
          const delayPatcher = await response.json();
          response = await fetch("rnbo.platereverb.json");
          const reverbPatcher = await response.json();
        
          // Create the devices
          const delayDevice = await createDevice({ context, patcher: delayPatcher });
          const reverbDevice = await createDevice({ context, patcher: reverbPatcher });
          
          oscillator.connect(delayDevice.node);
          delayDevice.node.connect(reverbDevice.node);
          reverbDevice.node.connect(outputNode);
          context.suspend();
          outputNode.gain.value = .3;  
      }
      setup();
    </script>
  </head>
  <body>
    <div class="controls">
        <h1>frequency links</h1>
        <p>a multi-person audio work</p>
        <section id = "nameStuff">
          <p id="instruction">enter your handle to begin</p>
          <input type="text" id="name">
          <button id="submit" onclick="submit()">submit</button>
        </section>
        <br>
      <div id="videoPlayer">
          <section id = "inputStuff">
          <p>enter a frequency and click send</p>
          <input type="text" id="frequency">
          <button id="send" onclick="sendFreq()">send</button>
        </section>
        <button id = "buttonText" onclick="gust()" style="opacity:0">play</button>
        <p class="freqState">idle...</p> 
        </div>
    </div>
  </body>
</html>
